name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Frontend Testing and Build
  frontend:
    name: Frontend Tests & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './app/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: app/dist/
          retention-days: 7

  # Backend Testing
  backend:
    name: Backend Tests & Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './api/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Check for syntax errors
        run: node -c $(find . -name "*.js" -not -path "./node_modules/*")
        continue-on-error: true

  # Security Audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install root dependencies
        run: npm ci --ignore-scripts

      - name: Install app dependencies
        working-directory: ./app
        run: npm ci --ignore-scripts

      - name: Install API dependencies
        working-directory: ./api
        run: npm ci --ignore-scripts

      - name: Run npm audit (Frontend)
        working-directory: ./app
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run npm audit (Backend)
        working-directory: ./api
        run: npm audit --audit-level=moderate
        continue-on-error: true

  # Dependency Review
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate

  # Code Quality Checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit messages
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking commit message format..."
          git log --format=%s ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | \
          grep -E '^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?: .+' || \
          echo "‚ö†Ô∏è Warning: Some commits don't follow conventional commit format"

      - name: Check file sizes
        run: |
          echo "Checking for large files..."
          find . -type f -size +500k -not -path "./node_modules/*" -not -path "./.git/*" | \
          while read file; do
            echo "‚ö†Ô∏è Large file detected: $file ($(du -h "$file" | cut -f1))"
          done

  # Build Summary
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [frontend, backend, security, quality]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "‚úÖ CI/CD Pipeline Complete"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "Backend: ${{ needs.backend.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Quality: ${{ needs.quality.result }}"

      - name: Post summary
        run: |
          if [ "${{ needs.frontend.result }}" == "success" ] && \
             [ "${{ needs.backend.result }}" == "success" ]; then
            echo "üéâ All checks passed! Ready to deploy."
            exit 0
          else
            echo "‚ùå Some checks failed. Please review."
            exit 1
          fi
